---
title: "20191109_Global_map"
author: "Gaotong LIU"
date: "11/9/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse) # Data manipulation
library(arsenal) # Descriptive statistics
library(leaflet) # Map
library(rworldmap) # Region map

library(plotly) # Interctive plot
library(countrycode)  # Gets country code 

library(viridis) # color pallet



knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis")

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))

```

Addditional packages>?
New packages?

## Load data
```{r}
happy = read_csv("/Users/gloria/Documents/CUMC/P8105 Data Science/P8105_final_report/data/2019.csv") %>% 
  janitor::clean_names()

happy_2019 = happy %>% 
  select(-c(sd_of_ladder, positive_affect, negative_affect)) %>% 
  rename("rank" = ladder) %>%
  pivot_longer(social_support : healthy_life_expectancy,
               names_to = "factors",
               values_to = "value")
  
```

## Descriptive statistics
```{r}
# Clean the output
my_controls <- tableby.control(
  total = T,
  test = F,  
  numeric.stats = c("meansd", "medianq1q3", "range"),
  stats.labels = list(
    meansd = "Mean (SD)",
    medianq1q3 = "Median (Q1, Q3)",
    range = "Min - Max"))

# Descriptive table
tab1 <- tableby( ~ social_support + freedom + corruption + generosity +log_of_gdp_per_capita + healthy_life_expectancy,
                 data = happy, control = my_controls, total = FALSE)
summary(tab1, title = "Descriptive statistics ", 
        text = T,  digits = 1) %>% 
  knitr::kable()
```

? why they have the same range? They have already been stardardized....problems?

## Overall plot aginst happiness score
```{r}
happy_2019 %>%
  ggplot(aes(x = rank, color = factors)) +
  geom_line(aes(y = value), alpha = .5) + 
  geom_smooth(method = "lm", aes(y = value), se = FALSE) +
  geom_line(aes(y = rank), color = "red") + 
  facet_grid(factors ~.)
```

Healthy_life_expectancy, Economic_GDP, social_support highly associated 

## Leaflet Map
```{r}
location = read_csv("/Users/gloria/Documents/CUMC/P8105 Data Science/P8105_final_report/data/concap.csv") %>% 
  janitor::clean_names() %>% 
  rename("country_region" = country_name )

happy_2019_cap = left_join(happy_2019, location, by = "country_region")

happy_2019_cap %>% 
  leaflet() %>% 
  addTiles() %>% 
  addMarkers(~capital_longitude, ~capital_latitude)
```

Not good map: only locaiton

### Leaflet with rank color
```{r}
pal = colorNumeric(
  palette = "viridis",
  domain = happy_2019_cap$rank)

happy_2019_cap %>% 
  leaflet() %>% 
  addTiles() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(
   ~capital_longitude, ~capital_latitude,
    color = ~pal(rank),
    radius = 1
  )
```

Better, but not best, how can we use the capital coordinates to represent the whole country? Can we do it in the plotly?

### Leaflet with lables
```{r}
happy_2019_cap %>% 
  pivot_wider(values_from = value,
              names_from = factors) %>% 
  mutate(label = str_c("<b>Rank: ", rank, "</b><br>GDP : ", log_of_gdp_per_capita , sep = "")
  ) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(
   ~capital_longitude, ~capital_latitude,
    color = ~ pal(rank),
   radius = 1,
   popup = ~ label)
```

Have labels but not showing too well, no bar graphs
No region

## other map packahes: rworldmap
```{r}
happy_2019_cap %>% 
  joinCountryData2Map(joinCode = "NAME", 
                      nameJoinColumn = "country_region") %>%
  mapCountryData(nameColumnToPlot = "rank",
                 catMethod = "fixedWidth")
```

NOT interactive: mapDevice('x11')

## Plotly: Map
```{r}
happy_2019_plot = happy_2019_cap %>%
  pivot_wider(values_from = value,
              names_from = factors) %>% 
 mutate(label = str_c("<b>Rank: ", rank, 
                      "</b><br>Country : ", country_region,
                      "</b><br>GDP : ", log_of_gdp_per_capita , 
                      "</b><br>Healthy : ", healthy_life_expectancy ,
                      sep = ""),
        code = countrycode(country_region, 'country.name', 'iso3c'),
        code = replace_na(code,"XKX"))
# light grey boundaries
l <- list(color = toRGB("grey"), width = 0.5)

# specify map projection/options
g <- list(
  showframe = FALSE,
  showcoastlines = FALSE,
  projection = list(type = 'Mercator')
)

plot_geo(happy_2019_plot) %>%
  add_trace(
    z = ~rank, color = ~rank, colors = 'Blues',
    text = ~label, locations = ~ code, marker = list(line = l)
  ) %>%
  colorbar(title = 'Happiness Rank') %>%
  layout(
    title = '2019 World Happiness Report',
    geo = g
  )

```

Do we need to include bar graphy/histograme of the other factors in the graph?
# Create a shareable link to your chart
# Set up API credentials: https://plot.ly/r/getting-started
chart_link = api_create(p, filename="choropleth-world")
chart_link